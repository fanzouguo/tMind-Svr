/*!
* tMind-Svr v2.2.16
* (c) 2021-2022  Smpoo soft Co. Shanghai China
* Released under the MIT License.
* Author: David
* CreateDate: 2021-03-05
* LastBuild: 2021-08-11 09:05:03
*/
import{tEcho as e,smpoo as t,tDate as s}from"tmind-core";import r from"ws";var i=(t,s,r=1)=>{e(t||"",s||"","ERR"),process.exit(r)};const n=require("fs-extra"),a={G:0,K:1,A:2,Z:3,H:4,J:5,E:6,Y:7,Q:8,X:9};const o=require("path"),c=require("fs-extra"),h=require("glob-all"),d=e=>e.replace(/\\\\|\\/g,"/");class l{constructor(e){this.#basePath=d(process.cwd()),this.#appPath=d(e)}#basePath;#appPath;get rootForlder(){return o.parse(this.rootPath).base}get rootPath(){return d(o.resolve(this.#basePath,"../.."))}get svrForlder(){return o.parse(this.#basePath).base}get svrPath(){return this.#basePath}get appForlder(){return o.parse(this.#appPath).base}get appPath(){return this.#appPath}get pathConf(){return d(o.resolve(this.#basePath,"../../.config"))}get pathLog(){return d(o.resolve(this.#basePath,"../../.data/logs"))}get pathScript(){return d(o.resolve(this.#basePath,"../../.script"))}get pathTask(){return d(o.resolve(this.#appPath,"@task"))}get pathRouter(){return d(o.resolve(this.#appPath,"@handler"))}getPath(e,...t){const s=("conf"===e?"../../.config":"logs"===e&&"../../.data/logs")||"script"===e&&"../../.script"||"cert"===e&&"../../.config/.cert"||"license"===e&&"../../.config/.license"||"router"===e&&"@handler"||"task"===e&&"@task"||"";return d(o.resolve(this.#appPath,s,t.join("/")))}prePath(e){c.ensure(e)}isExist(e){return!!h.sync(e).length}parse(e){return o.parse(e)}}const p=require("node-schedule"),u=(e,t,s)=>{p.scheduleJob(e,t,(()=>{"function"==typeof s&&s()}))};class g{constructor(e,t){this.#ident=e.svrForlder,this.#role=t.unit[this.#ident]?.schedule||"* * * * * *",this.#taskList=[];const s=e.getPath("task");e.isExist(`${s}/index.?s`)&&this.#taskList.push(require(s))}#ident;#role;#taskList;prepare(...e){for(const t of e)Array.isArray(t)?this.#taskList.push(...t):"function"==typeof t&&this.#taskList.push(t)}start(){if("* * * * * *"!==this.#role&&this.#taskList.length)for(const e of this.#taskList)if("function"==typeof e)u(this.#ident,this.#role,e);else if("object"==typeof e){const t=e?.schedule;t&&e.func&&"function"==typeof e.func&&u(this.#ident,t,e.func)}}stop(){p.cancel()}}const m=require("os"),f=require("fs-extra"),y=require("iconv-lite"),P=require("child_process"),$=(t,s=!0)=>new Promise(((r,i)=>{const n="cp936",a="binary";P.exec(t,{encoding:a},((t,o,c)=>{if(t)e("命令行执行失败，详情如下：","异常","ERR"),e(t,"","ERR"),s?process.exit(1):i(t);else{const e=y.decode(Buffer.from(o,a),n),t=y.decode(Buffer.from(c,a),n);t?i(t):r(e)}}))})),v=require("events"),k=require("request-promise");class S extends v{constructor(e){super(),this.pathMgr=new l(e),this.ident=this.pathMgr.svrForlder,this.configAll=(e=>{try{const t=e.getPath("conf"),s=n.readdirSync(t);if(s.includes(".license")){const r=e.rootForlder;((e,t)=>{try{const t=n.readFileSync(e.getPath("license","key")).toString();t||i("配置缺失","启动失败",0),t.split(/\r\n|\n/)[0].split(":")[1].split("0IO").map((e=>parseInt(e.split("").map((e=>a[e])).join("")))).decodeToStr()}catch(e){return i("配置缺失","启动失败",0),!1}})(e);const o={id:"",ident:"",namezh:"",addr:"",cert:{key:"",pem:""},secretKey:"",ver:"1.0.0",isDev:"dev"===(process.env.NODE_ENV||"").toLowerCase(),loggerUrl:"",dbUrl:"",unit:{}};let c=1,h={};for(const a of s)if(a.endsWith(".js")){const e=require(`${t}/${a}`);if(".index.js"===a)o.id=e.id,o.ident=r,o.namezh=e.namezh||i("工程名称配置项不允许为空","启动失败",1),o.addr=e.addr.map((e=>e||"localhost"))[o.isDev?0:1],o.secretKey=e.secretKey||i("加盐码不能为空","启动失败",1);else{const t={id:-1,ident:"",namezh:"",memo:"",addr:"",port:0,prefix:!1,corsed:!1,appendCorsHeader:[],disableMethods:[],corsWhiteList:[],schedule:"* * * * * *",linkToDb:!1},{id:s,ident:r,namezh:i,memo:n,addr:d,port:l,prefix:p,corsed:u,appendCorsHeader:g,disableMethods:m,corsWhiteList:f,schedule:y,linkToDb:P,...$}=e;t.id=!s||h[`${s}`]?c:parseInt(e.id),t.ident=a.replace(/Conf.js/g,""),t.namezh=i,t.memo=n,t.addr=d.map((e=>e||"localhost"))[o.isDev?0:1],t.port=l,t.prefix=p??!1,t.corsed=u??!1,t.appendCorsHeader=g||[],t.disableMethods=m||[],t.corsWhiteList=f||[],t.schedule=y||"* * * * * *",t.linkToDb="db"!==t.ident&&!!P;for(const e in $)t[e]=$[e];o.unit[t.ident]=t,h[`${t.id}`]=r,c++}}else if(".cert"===a){const t=n.readdirSync(e.getPath("cert"));for(const s of t){const t=e.getPath("cert",s);s.startsWith("local")?o.cert.ca=[n.readFileSync(t)]:s.includes("key")?o.cert.key=n.readFileSync(t):s.includes("cert")&&(o.cert.cert=n.readFileSync(t))}}return o?.unit?.log||(h=null),o.unit?.log?.addr?o.unit?.log?.port?o.loggerUrl=`ws://${o.unit.log.addr}:${o.unit.log.port}`:i("日志服务配置必须存在 port 参数，且不能为 0 或空","启动失败",1):i("日志服务配置缺少 addr 参数","启动失败",1),o.unit?.db?.addr?o.unit?.db?.port?o.dbUrl=`ws://${o.unit.db.addr}:${o.unit.db.port}`:i("日志服务配置必须存在 port 参数，且不能为 0 或空","启动失败",1):i("主业务数据库服务配置缺少 addr 参数","启动失败",1),o}return i("授权文件缺失","启动失败",0)}catch(e){return i("服务配置文件丢失或读取异常","启动失败",1)}})(this.pathMgr),this.config=this.configAll.unit[this.ident],this.#TimeTask=new g(this.pathMgr,this.configAll),this.#isPause=!1,this.onSSL=!!this.configAll.cert.key,this.#timTaskStoped=!1,this.on("error",(e=>{this.echo("监听到异常，详情如下：","错误","ERR"),this.echo(e)})),this.#logger=new r(this.configAll.loggerUrl),this.#logger.on("close",(()=>{this.exit("日志服务已终止，本服务也将随之终止.")})),this.#logger.on("error",(()=>{this.exit("日志写入失败，本服务也将随之终止.")}))}#TimeTask;#isPause;#timTaskStoped;#logger;get paused(){return this.#isPause}get addr(){return(this.config.addr||this.configAll.addr)[this.configAll.isDev?0:1]}get port(){return this.config.port}setTimeTask(...e){this.#TimeTask.prepare(...e)}echo(t,s,r){const i=t instanceof Error;s?e(t,s,r):i?console.error(t):console.log(t)}preErr(t,s,r){const i="string"==typeof t&&new Error(t)||t,n="boolean"==typeof s;i.code=s?n?13e3:s:13e3,(n||r)&&e("string"==typeof t?t:t.message,"异常","ERR"),this.emit("error",i)}setLog(e,t,s,r,i){this.#logger.send({msgType:e,msg:t,currLogType:s,reqId:r||-1,tag:i},(e=>{e&&this.exit("日志写入失败，服务已终止，请确保日志服务运行正常")}))}async http(e,t){const s="string"==typeof e,r=t&&"object"!=typeof t,i={uri:s&&e||e.uri,json:!0},n=!s&&e?.qs||!r&&t?.qs,a=!s&&e?.headers||!r&&t?.headers,o=r&&t||!s&&e?.method||"GET";n&&(i.qs=n),a&&(i.headers=a),o&&"GET"!==o&&(i.method=o);try{return await k(i)}catch(e){this.preErr(e,13005)}}start(){try{this.#TimeTask.start(),this.#timTaskStoped=!1;const{appCopy:r,consoleStr:i}=t();e(i(),"","INFO"),e(r,"","INFO"),e("-----------------------------------------------------------","","INFO"),e(`${s().format("YYYY-MM-DD hh:mi:sss")}\n\n`,"","INFO"),e(`物理IP：${class{static execCmd(e=!0,...t){for(const s of t)$(s,e)}static getSvrIp(){const e=m.networkInterfaces(),t={Main:"",IPv4:{},IPv6:{}},s=Object.entries(e);for(const e of s){const[s,r]=e,i=s.toLowerCase();for(const e of r){"IPv4"===e.family&&("wlan"===i||"eth0"===i||"eno1"===i)&&(t.Main=e.address);const r=`${s}`;t.IPv4[r]||(t.IPv4[r]=[]),t.IPv6[s]||(t.IPv6[r]=[]),"IPv4"===e.family?t.IPv4[r].push(e):"IPv6"===e.family&&t.IPv6[r].push(e)}}return t}static creatSSL(t,s,r){try{const e=new l(t),i=e.getPath("cert"),n=m.tmpdir().replace(/\\\\|\\/g,"/"),a=s,o=`${n}/${a}-ca.cnf`,c=`${n}/${a}-key.pem`,h=`${n}/${a}-csr.pem`,d=`${n}/${a}-cert.pem`,p=e.getPath("cert",`${a}-cert.crt`),u=`${n}/${a}-ca-svr.cnf`,g=e.getPath("cert",`${a}-svr-key.pem`),y=`${n}/${a}-svr-csr.pem`,P=e.getPath("cert",`${a}-svr-cert.pem`);f.writeFileSync(o,"#ca.cnf\n[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\n\n[req_distinguished_name]\ncountryName = Country Name (2 letter code)\ncountryName_default = CN\nstateOrProvinceName = State or Province Name (full name)\nstateOrProvinceName_default = ShangHai\nlocalityName = Locality Name (eg, city)\nlocalityName_default = ShangHai\norganizationalUnitName  = Organizational Unit Name (eg, section)\norganizationalUnitName_default  = smpoo\ncommonName = smpoo root CA\ncommonName_max  = 64\n\n[ v3_req ]\n# Extensions to add to a certificate request\nsubjectKeyIdentifier = hash\n#authorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical,CA:true\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign"),f.writeFileSync(u,`[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\n\n[req_distinguished_name]\ncountryName = Country Name (2 letter code)\ncountryName_default = CN\nstateOrProvinceName = State or Province Name (full name)\nstateOrProvinceName_default = ShangHai\nlocalityName = Locality Name (eg, city)\nlocalityName_default = ShangHai\norganizationalUnitName  = Organizational Unit Name (eg, section)\norganizationalUnitName_default  = smpoo\ncommonName = smpoo node server\ncommonName_max  = 64\n\n[ v3_req ]\n# Extensions to add to a certificate request\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer:always\nbasicConstraints = CA:FALSE\nkeyUsage = nonRepudiation, digitalSignature, keyEncipherment\nsubjectAltName = @alt_names\n\n[alt_names]\n# 注意这个IP.1的设置，IP地址需要和服务器的监听地址一样\nIP.1 = ${r??this.getSvrIp().Main}\nIP.2 = 127.0.0.1`);const $=[`cd ${i}`,`openssl genrsa -out ${c} -des 2048`,`openssl req -new -config ${o} -key ${c} -out ${h}`,`openssl x509 -req -extfile ${o} -extensions v3_req -days 7300 -in ${h} -signkey ${c} -out ${d}`,`openssl x509 -outform der -in ${d} -out ${p}`,`openssl genrsa -out ${g} 2048`,`openssl req -new -config ${u} -key ${g} -out ${y}`,`openssl x509 -req -CA ${d} -CAkey ${c} -CAcreateserial -extfile ${u} -extensions v3_req -days 3650 -in ${y} -out ${P}`,`cd ${e.appPath}`];this.execCmd(!0,...$)}catch(t){e("SSL文件构造失败，详情如下：","失败","ERR"),e(t,"","ERR")}}}.getSvrIp().Main}`,"","INFO"),e(`配置指向：${this.addr}`,"","INFO");const n=this.config.namezh?`[${this.config.namezh}]`:"";e(`${n}服务端已启动......\n\n    Enjoy it!\n\n`,`HTTP${this.onSSL?"/s":""}：${this.port}`,"SUCC")}catch(e){this.echo(e.message,"启动失败"),this.echo(e),process.exit(1)}}stop(t){this.#timTaskStoped=!0,this.#TimeTask.stop(),e(t||"已停止服务端","手动","WARN"),process.exit(0)}pause(e){e&&(this.#TimeTask.stop(),this.#timTaskStoped=!0),this.#isPause=!0,this.echo("服务已暂停","警告！","WARN")}resume(){this.#timTaskStoped&&this.#TimeTask.start(),this.#isPause=!1,this.echo("服务已恢复","信息","INFO")}exit(t,s){this.#TimeTask.stop(),e(t||`[${this.config.namezh}]服务端无法启动`,"启动异常","ERR"),process.exit(s??1)}}const N=require("koa"),x=class extends S{constructor(e){super(e),this.#app=new N,this.#app.use((async(e,t)=>{e.body="测试",await t()}))}#app;get app(){return this.#app}start(){this.#app.listen(super.config.port),super.start()}},b=class extends S{constructor(e){super(e)}};export{b as DbSvr,x as KoaSvr};
