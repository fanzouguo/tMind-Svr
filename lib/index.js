/*!
* tmind-svr v2.2.37
* (c) 2021-2022  Smpoo soft Co. Shanghai China
* Released under the MIT License.
* Author: 上海深普软件.Co.David
* CreateDate: 2021-03-13 07:02:42.668
* LastBuild: 2021-08-16 17:28:43
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("tmind-core"),require("ws")):"function"==typeof define&&define.amd?define(["exports","tmind-core","ws"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).tmindSvr={},e.tmindCore,e.WebSocket)}(this,(function(e,t,s){"use strict";var i=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(s),n=(e,s,i=1)=>{t.tEcho(e||"",s||"","ERR"),process.exit(i)};const o=require("fs-extra"),r="配置缺失",a="启动失败",c={G:0,K:1,A:2,Z:3,H:4,J:5,E:6,Y:7,Q:8,X:9};const h=require("path"),l=require("fs-extra"),d=require("glob-all"),p="../../.config",g="../../.data/logs",u="../../.script",f="@handler",m="@task",y=e=>e.replace(/\\\\|\\/g,"/");class E{constructor(e){this.#basePath=y(process.cwd()),this.#appPath=y(e)}#basePath;#appPath;get rootFolder(){return h.parse(this.rootPath).base}get rootPath(){return y(h.resolve(this.#basePath,"../.."))}get svrFolder(){return h.parse(this.#basePath).base}get svrPath(){return this.#basePath}get appFolder(){return h.parse(this.#appPath).base}get appPath(){return this.#appPath}get pathConf(){return y(h.resolve(this.#basePath,p))}get pathLog(){return y(h.resolve(this.#basePath,g))}get pathScript(){return y(h.resolve(this.#basePath,u))}get pathTask(){return y(h.resolve(this.#appPath,m))}get pathRouter(){return y(h.resolve(this.#appPath,f))}getPath(e,...t){const s=("conf"===e?p:"logs"===e&&g)||"script"===e&&u||"cert"===e&&"../../.config/.cert"||"license"===e&&"../../.config/.license"||"router"===e&&f||"task"===e&&m||"";return y(h.resolve("router"===e||"task"===e?this.#appPath:this.#basePath,s,t.join("/")))}prePath(e){l.ensure(e)}isExist(e){return!!d.sync(e).length}parse(e){return h.parse(e)}}const $=require("node-schedule"),P="* * * * * *",v=(e,t,s)=>{$.scheduleJob(e,t,(()=>{"function"==typeof s&&s()}))};class N{constructor(e,t,s){this.#ident=s,this.#role=t.unit[s]?.schedule||P,this.#taskList=[];const i=e.getPath("task");e.isExist(`${i}/index.?s`)&&this.#taskList.push(require(i))}#ident;#role;#taskList;prepare(...e){for(const t of e)Array.isArray(t)?this.#taskList.push(...t):"function"==typeof t&&this.#taskList.push(t)}start(){if(this.#role!==P&&this.#taskList.length)for(const e of this.#taskList)if("function"==typeof e)v(this.#ident,this.#role,e);else if("object"==typeof e){const t=e?.schedule;t&&e.func&&"function"==typeof e.func&&v(this.#ident,t,e.func)}}stop(){}}const S=require("os"),b=require("fs-extra"),C=require("iconv-lite"),I=require("child_process"),k=(e,s=!0)=>new Promise(((i,n)=>{const o="cp936",r="binary";I.exec(e,{encoding:r},((e,a,c)=>{if(e)t.tEcho("命令行执行失败，详情如下：","异常","ERR"),t.tEcho(e,"","ERR"),s?process.exit(1):n(e);else{const e=C.decode(Buffer.from(a,r),o),t=C.decode(Buffer.from(c,r),o);t?n(t):i(e)}}))})),x=require("events"),R=require("request-promise");class q extends x{constructor(e){super(),this.showLog=!1,this.pathMgr=new E(e),this.ident=this.pathMgr.svrFolder.replace(/Svr/,""),this.configAll=(e=>{try{const t=e.getPath("conf"),s=o.readdirSync(t);if(s.includes(".license")){const i=e.rootFolder;((e,t)=>{try{const t=o.readFileSync(e.getPath("license","key")).toString();t||n(r,a,0),t.split(/\r\n|\n/)[0].split(":")[1].split("0IO").map((e=>parseInt(e.split("").map((e=>c[e])).join("")))).decodeToStr()}catch(e){return n(r,a,0),!1}})(e);const h={id:"",ident:"",namezh:"",addr:"",cert:{key:"",pem:""},secretKey:"",ver:"1.0.0",isDev:"dev"===(process.env.NODE_ENV||"").toLowerCase(),loggerUrl:"",dbUrl:"",unit:{}};let l=1,d={};for(const r of s)if(r.endsWith(".js")){const e=require(`${t}/${r}`);if(".index.js"===r)h.id=e.id,h.ident=i,h.namezh=e.namezh||n("工程名称配置项不允许为空",a,1),h.addr=e.addr.map((e=>e||"localhost"))[h.isDev?0:1],h.secretKey=e.secretKey||n("加盐码不能为空",a,1);else{const t={id:-1,ident:"",namezh:"",memo:"",addr:"",port:0,prefix:!1,corsed:!1,appendCorsHeader:[],disableMethods:[],corsWhiteList:[],schedule:"* * * * * *",linkToDb:!1},{id:s,ident:i,namezh:n,memo:o,addr:a,port:c,prefix:p,corsed:g,appendCorsHeader:u,disableMethods:f,corsWhiteList:m,schedule:y,linkToDb:E,...$}=e;t.id=!s||d[`${s}`]?l:parseInt(e.id),t.ident=r.replace(/Conf.js/g,"").replace(/^\./,""),t.namezh=n,t.memo=o,t.addr=a.map((e=>e||"localhost"))[h.isDev?0:1],t.port=c,t.prefix=p??!1,t.corsed=g??!1,t.appendCorsHeader=u||[],t.disableMethods=f||[],t.corsWhiteList=m||[],t.schedule=y||"* * * * * *",t.linkToDb="db"!==t.ident&&!!E;for(const e in $)t[e]=$[e];h.unit[t.ident]=t,d[`${t.id}`]=i,l++}}else if(".cert"===r){const t=o.readdirSync(e.getPath("cert"));for(const s of t){const t=e.getPath("cert",s);s.startsWith("local")?h.cert.ca=[o.readFileSync(t)]:s.includes("key")?h.cert.key=o.readFileSync(t):s.includes("cert")&&(h.cert.cert=o.readFileSync(t))}}return h?.unit?.log||(d=null),h.unit?.log?.addr?h.unit?.log?.port?h.loggerUrl=`ws://${h.unit.log.addr}:${h.unit.log.port}`:n("日志服务配置必须存在 port 参数，且不能为 0 或空",a,1):n("日志服务配置缺少 addr 参数",a,1),h.unit?.db?.addr?h.unit?.db?.port?h.dbUrl=`ws://${h.unit.db.addr}:${h.unit.db.port}`:n("日志服务配置必须存在 port 参数，且不能为 0 或空",a,1):n("主业务数据库服务配置缺少 addr 参数",a,1),h}return n("授权文件缺失",a,0)}catch(e){return n("服务配置文件丢失或读取异常",a,1)}})(this.pathMgr),this.config=this.configAll.unit[this.ident],this.#TimeTask=new N(this.pathMgr,this.configAll,this.ident),this.#isPause=!1,this.onSSL=!!this.configAll.cert.key,this.#timTaskStoped=!1,this.on("error",(e=>{this.setErr(e,13006,-1,"监听到异常")})),process.on("uncaughtException",(e=>{this.setErr(e,13007,-1,"未捕获的异常")})),process.on("unhandledRejection",(e=>{this.setErr(e,13008,-1,"未捕获的Reject")}))}#TimeTask;#isPause;#timTaskStoped;#logger;connectToLog(){return new Promise(((e,t)=>{"log"!==this.ident?(this.#logger=new i.default(this.configAll.loggerUrl),this.#logger.on("open",(()=>{this.setInfo("已连接到日志服务",11101,-1,"boot"),e("")})),this.#logger.on("close",(()=>{this.exit("日志服务已终止，本服务也将随之终止."),t()})),this.#logger.on("error",(e=>{t(e.code),"ECONNREFUSED"===e.code&&this.exit("由于日志服务连接失败，服务终止了启动"),this.exit("日志写入失败，本服务也将随之终止.")}))):e("")}))}get paused(){return this.#isPause}setTimeTask(...e){this.#TimeTask.prepare(...e)}setInfo(e,s,i,n,o,r="INFO"){if("log"!==this.ident)if("INFO"===r||"SUCC"===r){if(this.#logger){const a={logId:i||-1,from:this.config.namezh,tag:n||"",name:"",message:e,type:r,level:s||11e3};this.#logger.send(JSON.stringify(a),(e=>{e&&this.exit("日志写入失败，服务已终止，请确保日志服务运行正常")})),this.showLog&&t.tEcho(e,o||"信息",r)}}else t.tEcho("setInfo的msgType类型取值只能为：INFO | SUCC","代码级错误","ERR");else t.tEcho("日志服务器不支持 setInfo 方法","警告！","WARN")}setWarn(e,s,i,n){if("log"!==this.ident){if(this.#logger){const o={logId:i||-1,from:this.config.namezh,tag:n||"",name:"",message:e,type:"WARN",level:s||12e3};this.#logger.send(JSON.stringify(o),(e=>{e&&this.exit("日志写入失败，服务已终止，请确保日志服务运行正常")})),this.showLog&&t.tEcho(e,"警告","WARN")}}else t.tEcho("日志服务器不支持 setWarn 方法","警告！","WARN")}setErr(e,s,i,n){if("log"!==this.ident){if(this.#logger){const o=e instanceof Error,r={logId:i||-1,from:this.config.namezh,tag:n||"",code:o?e.code:"",name:o?e.name:"",message:o?e.message:e,stack:o?e.stack:"",type:"ERR",level:s||13e3};this.#logger.send(JSON.stringify(r),(e=>{e&&this.exit("日志写入失败，服务已终止，请确保日志服务运行正常")})),this.emit("error",r),this.showLog&&t.tEcho(r,`${n||""}异常`,"ERR")}}else t.tEcho("日志服务器不支持 setErr 方法","警告！","WARN")}async http(e,t){const s="string"==typeof e,i=t&&"object"!=typeof t,n={uri:s&&e||e.uri,json:!0},o=!s&&e?.qs||!i&&t?.qs,r=!s&&e?.headers||!i&&t?.headers,a=i&&t||!s&&e?.method||"GET";o&&(n.qs=o),r&&(n.headers=r),a&&"GET"!==a&&(n.method=a);try{return await R(n)}catch(e){this.setErr(e,13005,-1,"Svr Http")}}async start(){try{t.tEcho("连接日志服务...","准备中","INFO"),await this.connectToLog(),t.tEcho("日志服务已连接","Next","SUCC"),this.#TimeTask.start(),this.#timTaskStoped=!1;const{appCopy:e,consoleStr:s}=t.smpoo();t.tEcho(s(),"","INFO"),t.tEcho(e,"","INFO"),t.tEcho("-----------------------------------------------------------","","INFO"),t.tEcho(`${t.tDate().format("YYYY-MM-DD hh:mi:sss")}\n\n`,"","INFO"),t.tEcho(`物理IP：${class{static execCmd(e=!0,...t){for(const s of t)k(s,e)}static getSvrIp(){const e=S.networkInterfaces(),t={Main:"",IPv4:{},IPv6:{}},s=Object.entries(e);for(const e of s){const[s,i]=e,n=s.toLowerCase();for(const e of i){"IPv4"===e.family&&("wlan"===n||"eth0"===n||"eno1"===n)&&(t.Main=e.address);const i=`${s}`;t.IPv4[i]||(t.IPv4[i]=[]),t.IPv6[s]||(t.IPv6[i]=[]),"IPv4"===e.family?t.IPv4[i].push(e):"IPv6"===e.family&&t.IPv6[i].push(e)}}return t}static creatSSL(e,s,i){try{const t=new E(e),n=t.getPath("cert"),o=S.tmpdir().replace(/\\\\|\\/g,"/"),r=s,a=`${o}/${r}-ca.cnf`,c=`${o}/${r}-key.pem`,h=`${o}/${r}-csr.pem`,l=`${o}/${r}-cert.pem`,d=t.getPath("cert",`${r}-cert.crt`),p=`${o}/${r}-ca-svr.cnf`,g=t.getPath("cert",`${r}-svr-key.pem`),u=`${o}/${r}-svr-csr.pem`,f=t.getPath("cert",`${r}-svr-cert.pem`);b.writeFileSync(a,"#ca.cnf\n[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\n\n[req_distinguished_name]\ncountryName = Country Name (2 letter code)\ncountryName_default = CN\nstateOrProvinceName = State or Province Name (full name)\nstateOrProvinceName_default = ShangHai\nlocalityName = Locality Name (eg, city)\nlocalityName_default = ShangHai\norganizationalUnitName  = Organizational Unit Name (eg, section)\norganizationalUnitName_default  = smpoo\ncommonName = smpoo root CA\ncommonName_max  = 64\n\n[ v3_req ]\n# Extensions to add to a certificate request\nsubjectKeyIdentifier = hash\n#authorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical,CA:true\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign"),b.writeFileSync(p,`[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\n\n[req_distinguished_name]\ncountryName = Country Name (2 letter code)\ncountryName_default = CN\nstateOrProvinceName = State or Province Name (full name)\nstateOrProvinceName_default = ShangHai\nlocalityName = Locality Name (eg, city)\nlocalityName_default = ShangHai\norganizationalUnitName  = Organizational Unit Name (eg, section)\norganizationalUnitName_default  = smpoo\ncommonName = smpoo node server\ncommonName_max  = 64\n\n[ v3_req ]\n# Extensions to add to a certificate request\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer:always\nbasicConstraints = CA:FALSE\nkeyUsage = nonRepudiation, digitalSignature, keyEncipherment\nsubjectAltName = @alt_names\n\n[alt_names]\n# 注意这个IP.1的设置，IP地址需要和服务器的监听地址一样\nIP.1 = ${i??this.getSvrIp().Main}\nIP.2 = 127.0.0.1`);const m=[`cd ${n}`,`openssl genrsa -out ${c} -des 2048`,`openssl req -new -config ${a} -key ${c} -out ${h}`,`openssl x509 -req -extfile ${a} -extensions v3_req -days 7300 -in ${h} -signkey ${c} -out ${l}`,`openssl x509 -outform der -in ${l} -out ${d}`,`openssl genrsa -out ${g} 2048`,`openssl req -new -config ${p} -key ${g} -out ${u}`,`openssl x509 -req -CA ${l} -CAkey ${c} -CAcreateserial -extfile ${p} -extensions v3_req -days 3650 -in ${u} -out ${f}`,`cd ${t.appPath}`];this.execCmd(!0,...m)}catch(e){t.tEcho("SSL文件构造失败，详情如下：","失败","ERR"),t.tEcho(e,"","ERR")}}}.getSvrIp().Main}`,"","INFO"),t.tEcho(`配置指向：${this.config.addr}`,"","INFO");const i=this.config.namezh?`[${this.config.namezh}]`:"";t.tEcho(`${i}服务端已启动......\n\n    Enjoy it!\n\n`,`HTTP${this.onSSL?"/s":""}：${this.config.port}`,"SUCC"),"log"!==this.ident&&this.setInfo(`[${this.config.namezh}] Server is start at ${this.config.addr}:${this.config.port} in ${t.tDate().format("YYYY-MM-DD hh:mi:ss.ms")}`,11101,-1,"boot","","SUCC")}catch(e){t.tEcho(e,"启动失败","ERR"),process.exit(1)}}stop(e){this.#timTaskStoped=!0,this.#TimeTask.stop(),t.tEcho(e||"已停止服务端","手动","WARN"),process.exit(0)}pause(e){e&&(this.#TimeTask.stop(),this.#timTaskStoped=!0),this.#isPause=!0,t.tEcho("服务已暂停","警告！","WARN")}resume(){this.#timTaskStoped&&this.#TimeTask.start(),this.#isPause=!1,t.tEcho("服务已恢复","信息","INFO")}exit(e,s){this.#TimeTask.stop(),t.tEcho(e||`[${this.config.namezh}]服务端无法启动`,"启动异常","ERR"),process.exit(s??1)}}const T=require("koa"),{JsonDB:w}=require("node-json-db"),{Config:_}=require("node-json-db/dist/lib/JsonDBConfig"),L=!0,W=!1,O=()=>t.tDate().format("YYYY-MM-DD hh:mi:ss.ms"),A=q;e.BaseSvr=A,e.KoaSvr=class extends q{constructor(e){super(e),this.#app=new T,this.#app.use((async(e,t)=>{e.body="测试",await t()}))}#app;get app(){return this.#app}async start(){this.#app.listen(this.config.port),super.start()}},e.LogSvr=class extends q{constructor(e){super(e);const i=this.pathMgr.getPath("logs",`${t.tDate().format("YYYY-MM-DD")}`);this.#dbInfo=new w(new _(`${i}/info.json`,L,W,".")),this.#dbWarn=new w(new _(`${i}/warn.json`,L,W,".")),this.#dbErr=new w(new _(`${i}/err.json`,L,W,".")),this.#logCacheInfo=[],this.#logCacheWarn=[],this.#logCacheErr=[],new s.Server({host:this.config.addr,port:this.config.port}).on("connection",(e=>{let t="";e.on("message",(e=>{const s=JSON.parse(e.toString());t||(t=s.from),s.datatime=O(),"ERR"===s.type?this.#logCacheErr.push(s):"WARN"===s.type?this.#logCacheWarn.push(s):this.#logCacheInfo.push(s)})),e.on("close",((e,s)=>{this.#logCacheWarn.push({logId:-1,from:t,tag:"stop",code:e,name:"",message:`${t}与日志服务器的连接已断开。\n${e}\n${s||""}`,datatime:O(),type:"WARN",level:12001})}))}))}#dbInfo;#dbWarn;#dbErr;#logCacheInfo;#logCacheWarn;#logCacheErr;async start(){this.setTimeTask((()=>{try{const e=t.tDate().format(".hh时.mi分");this.#logCacheInfo.length&&this.#dbInfo.push(e,this.#logCacheInfo.splice(0,this.#logCacheInfo.length),!1),this.#logCacheWarn.length&&this.#dbWarn.push(e,this.#logCacheWarn.splice(0,this.#logCacheWarn.length),!1),this.#logCacheErr.length&&this.#dbErr.push(e,this.#logCacheErr.splice(0,this.#logCacheErr.length),!1)}catch(e){t.tEcho("日志存盘失败，详情如下：","异常","ERR"),t.tEcho(e,"","ERR")}})),super.start()}},Object.defineProperty(e,"__esModule",{value:!0})}));
