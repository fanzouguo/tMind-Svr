/*!
* tMind-Svr v2.2.13
* (c) 2021-2022  Smpoo soft Co. Shanghai China
* Released under the MIT License.
* Author: David
* CreateDate: 2021-03-05
* LastBuild: 2021-08-09 07:01:53
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tmind-core")):"function"==typeof define&&define.amd?define(["tmind-core"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).tmindSvr=t(e.tmindCore)}(this,(function(e){"use strict";class t extends Error{constructor(t,s,r){super("string"==typeof t?t:t.message);const n="boolean"==typeof s;this.code=s?n?1e4:s:1e4,(n||r)&&e.tEcho("string"==typeof t?t:t.message,"异常","ERR")}}var s=(t,s,r=1)=>{e.tEcho(t||"",s||"","ERR"),process.exit(r)};const r=require("fs-extra"),n="配置缺失",i="启动失败",o={G:0,K:1,A:2,Z:3,H:4,J:5,E:6,Y:7,Q:8,X:9};const a=require("path"),c=require("fs-extra"),h=require("glob-all"),d="../../.config",p="../../.data/logs",u="../../.script",l="@handler",m="@task",g=e=>e.replace(/\\\\|\\/g,"/");class f{constructor(e){this.#basePath=g(process.cwd()),this.#appPath=g(e)}#basePath;#appPath;get rootForlder(){return a.parse(this.rootPath).base}get rootPath(){return g(a.resolve(this.#basePath,"../.."))}get svrForlder(){return a.parse(this.#basePath).base}get svrPath(){return this.#basePath}get appForlder(){return a.parse(this.#appPath).base}get appPath(){return this.#appPath}get pathConf(){return g(a.resolve(this.#basePath,d))}get pathLog(){return g(a.resolve(this.#basePath,p))}get pathScript(){return g(a.resolve(this.#basePath,u))}get pathTask(){return g(a.resolve(this.#appPath,m))}get pathRouter(){return g(a.resolve(this.#appPath,l))}getPath(e,...t){const s=("conf"===e?d:"logs"===e&&p)||"script"===e&&u||"cert"===e&&"../../.config/.cert"||"license"===e&&"../../.config/.license"||"router"===e&&l||"task"===e&&m||"";return g(a.resolve(this.#appPath,s,t.join("/")))}prePath(e){c.ensure(e)}isExist(e){return!!h.sync(e).length}parse(e){return a.parse(e)}}const y=require("os"),P=require("fs-extra"),v=require("iconv-lite"),$=require("child_process"),N=(t,s=!0)=>new Promise(((r,n)=>{const i="cp936",o="binary";$.exec(t,{encoding:o},((t,a,c)=>{if(t)e.tEcho("命令行执行失败，详情如下：","异常","ERR"),e.tEcho(t,"","ERR"),s?process.exit(1):n(t);else{const e=v.decode(Buffer.from(a,o),i),t=v.decode(Buffer.from(c,o),i);t?n(t):r(e)}}))}));var x=(t,s,r)=>{const{appCopy:n,consoleStr:i}=e.smpoo();e.tEcho(i(),"","INFO"),e.tEcho(n,"","INFO"),e.tEcho("-----------------------------------------------------------","","INFO"),e.tEcho(`${e.tDate().format("YYYY-MM-DD hh:mi:sss")}\n\n`,"","info"),e.tEcho(class{static execCmd(e=!0,...t){for(const s of t)N(s,e)}static getSvrIp(){const e=y.networkInterfaces(),t={Main:"",IPv4:{},IPv6:{}},s=Object.entries(e);for(const e of s){const[s,r]=e,n=s.toLowerCase();for(const e of r){"IPv4"===e.family&&("wlan"===n||"eth0"===n||"eno1"===n)&&(t.Main=e.address);const r=`${s}`;t.IPv4[r]||(t.IPv4[r]=[]),t.IPv6[s]||(t.IPv6[r]=[]),"IPv4"===e.family?t.IPv4[r].push(e):"IPv6"===e.family&&t.IPv6[r].push(e)}}return t}static creatSSL(t,s,r){try{const e=new f(t),n=e.getPath("cert"),i=y.tmpdir().replace(/\\\\|\\/g,"/"),o=s,a=`${i}/${o}-ca.cnf`,c=`${i}/${o}-key.pem`,h=`${i}/${o}-csr.pem`,d=`${i}/${o}-cert.pem`,p=e.getPath("cert",`${o}-cert.crt`),u=`${i}/${o}-ca-svr.cnf`,l=e.getPath("cert",`${o}-svr-key.pem`),m=`${i}/${o}-svr-csr.pem`,g=e.getPath("cert",`${o}-svr-cert.pem`);P.writeFileSync(a,"#ca.cnf\n[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\n\n[req_distinguished_name]\ncountryName = Country Name (2 letter code)\ncountryName_default = CN\nstateOrProvinceName = State or Province Name (full name)\nstateOrProvinceName_default = ShangHai\nlocalityName = Locality Name (eg, city)\nlocalityName_default = ShangHai\norganizationalUnitName  = Organizational Unit Name (eg, section)\norganizationalUnitName_default  = smpoo\ncommonName = smpoo root CA\ncommonName_max  = 64\n\n[ v3_req ]\n# Extensions to add to a certificate request\nsubjectKeyIdentifier = hash\n#authorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical,CA:true\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign"),P.writeFileSync(u,`[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\n\n[req_distinguished_name]\ncountryName = Country Name (2 letter code)\ncountryName_default = CN\nstateOrProvinceName = State or Province Name (full name)\nstateOrProvinceName_default = ShangHai\nlocalityName = Locality Name (eg, city)\nlocalityName_default = ShangHai\norganizationalUnitName  = Organizational Unit Name (eg, section)\norganizationalUnitName_default  = smpoo\ncommonName = smpoo node server\ncommonName_max  = 64\n\n[ v3_req ]\n# Extensions to add to a certificate request\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer:always\nbasicConstraints = CA:FALSE\nkeyUsage = nonRepudiation, digitalSignature, keyEncipherment\nsubjectAltName = @alt_names\n\n[alt_names]\n# 注意这个IP.1的设置，IP地址需要和服务器的监听地址一样\nIP.1 = ${r??this.getSvrIp().Main}\nIP.2 = 127.0.0.1`);const v=[`cd ${n}`,`openssl genrsa -out ${c} -des 2048`,`openssl req -new -config ${a} -key ${c} -out ${h}`,`openssl x509 -req -extfile ${a} -extensions v3_req -days 7300 -in ${h} -signkey ${c} -out ${d}`,`openssl x509 -outform der -in ${d} -out ${p}`,`openssl genrsa -out ${l} 2048`,`openssl req -new -config ${u} -key ${l} -out ${m}`,`openssl x509 -req -CA ${d} -CAkey ${c} -CAcreateserial -extfile ${u} -extensions v3_req -days 3650 -in ${m} -out ${g}`,`cd ${e.appPath}`];this.execCmd(!0,...v)}catch(t){e.tEcho("SSL文件构造失败，详情如下：","失败","ERR"),e.tEcho(t,"","ERR")}}}.getSvrIp().Main,"","INFO");const o=r?`[${r}]`:"";e.tEcho(`${o}服务端已启动......\n\n    Enjoy it!\n\n`,`HTTP${t?"/s":""}：${s}`,"SUCC")};const E=require("events"),q=require("request-promise");class S extends E{constructor(e){super(),this.#pathMgr=new f(e),this.#ident=this.#pathMgr.svrForlder,this.#config=(e=>{try{const t=e.getPath("conf"),a=r.readdirSync(t);if(a.includes(".license")){const c=e.rootForlder;((e,t)=>{try{const t=r.readFileSync(e.getPath("license","key")).toString();t||s(n,i,0),t.split(/\r\n|\n/)[0].split(":")[1].split("0IO").map((e=>parseInt(e.split("").map((e=>o[e])).join("")))).decodeToStr()}catch(e){return s(n,i,0),!1}})(e);const h={id:"",ident:"",namezh:"",cert:{key:"",pem:""},secretKey:"",ver:"1.0.0",isDev:"dev"===(process.env.NODE_ENV||"").toLowerCase(),unit:{}};let d=1,p={};for(const n of a)if(n.endsWith(".js")){const e=require(`${t}/${n}`);if(".index.js"===n)h.id=e.id,h.ident=c,h.namezh=e.namezh||s("工程名称配置项不允许为空",i,1),h.secretKey=e.secretKey||s("加盐码不能为空",i,1);else{const t={id:-1,ident:"",namezh:"",memo:"",addr:["",""],port:-1,prefix:!1,corsed:!1,appendCorsHeader:[],disableMethods:[],corsWhiteList:[],schedule:"* * * * * *"},{id:s,ident:r,namezh:i,memo:o,addr:a,port:c,prefix:u,corsed:l,appendCorsHeader:m,disableMethods:g,corsWhiteList:f,schedule:y,...P}=e;t.id=!s||p[`${s}`]?d:parseInt(e.id),t.ident=`svr${n.replace(/\.js|\.conf/g,"")}`,t.namezh=i,t.memo=o,t.addr=a||["",""],t.port=c||3e3,t.prefix=u??!1,t.corsed=l??!1,t.appendCorsHeader=m||[],t.disableMethods=g||[],t.corsWhiteList=f||[],t.schedule=y||"* * * * * *";for(const e in P)t[e]=P[e];h.unit[t.ident]=t,p[`${t.id}`]=r,d++}}else if(".cert"===n){const t=r.readdirSync(e.getPath("cert"));for(const s of t){const t=e.getPath("cert",s);s.startsWith("local")?h.cert.ca=[r.readFileSync(t)]:s.includes("key")?h.cert.key=r.readFileSync(t):s.includes("cert")&&(h.cert.cert=r.readFileSync(t))}}return p=null,h}return s("授权文件缺失",i,0),{}}catch(e){return s("服务端私有配置文件丢失或读取异常",i,1),{}}})(this.#pathMgr),this.#isPause=!1,this.#isHttps=!!this.#config.cert.key,this.on("error",(e=>{this.echo("监听到异常，详情如下：","错误","ERR"),this.echo(e)}))}#ident;#pathMgr;#config;#isPause;#isHttps;get pathMgr(){return this.#pathMgr||{}}get config(){return this.#config.unit[this.#ident]||{}}get configAll(){return this.#config||{}}get status(){return this.#isPause}echo(t,s,r){const n=t instanceof Error;s?e.tEcho(t,s,r):n?console.error(t):console.log(t)}start(){try{x(this.#isHttps,this.config.port,this.config.namezh)}catch(e){this.echo(e.message,"启动失败"),this.echo(e),process.exit(1)}}stop(t){e.tEcho(t||"已停止服务端","手动","WARN"),process.exit(0)}pause(){this.#isPause=!0,this.echo("服务已暂停","警告！","WARN")}resume(){this.#isPause=!1,this.echo("服务已恢复","信息","INFO")}exit(t,s){e.tEcho(t||`[${this.config.namezh}]服务端无法启动`,"启动异常","ERR"),process.exit(s??1)}async http(e,s){const r="string"==typeof e,n=s&&"object"!=typeof s,i={uri:r&&e||e.uri,json:!0},o=!r&&e?.qs||!n&&s?.qs,a=!r&&e?.headers||!n&&s?.headers,c=n&&s||!r&&e?.method||"GET";o&&(i.qs=o),a&&(i.headers=a),c&&"GET"!==c&&(i.method=c);try{return await q(i)}catch(e){this.emit("error",new t(e,10005,!0))}}}const _=require("koa");return{KoaSvr:class extends S{constructor(e){super(e),this.#app=new _,this.#app.use((async(e,t)=>{e.body="测试",await t()}))}#app;get app(){return this.#app}start(){this.#app.listen(super.config.port),super.start()}},DbSvr:class extends S{constructor(e){super(e)}}}}));
